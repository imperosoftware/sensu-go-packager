version: "v1.0"
name: "Sensu-go OSS Packager"

agent:
  machine:
    type: e1-standard-2

  containers:
    - name: "gobuilder"
      image: "registry.semaphoreci.com/golang:1.16.6-stretch"

blocks:
  - name: "sensu-agent"
    task:
      env_vars:
        - name: "SENSU_GO_VERSION"
          value: "v6.4.1"
        - name: "SENSU_GO_PKG_NAME"
          value: "sensu-go-agent_6.4.1-4969_amd64.deb"
      jobs:
        - name: "Build sensu-agent"
          commands:
            - "cd /" # go image defaults you in /go
            - "git -c advice.detachedHead=false clone --branch ${SENSU_GO_VERSION} --depth 1 https://github.com/sensu/sensu-go"
            - "cd sensu-go"
            - "go build -ldflags '-X \"github.com/sensu/sensu-go/version.Version='${SENSU_GO_VERSION}'\" -X \"github.com/sensu/sensu-go/version.BuildDate='$(date +%Y-%m-%d)'\" -X \"github.com/sensu/sensu-go/version.BuildSHA='$(git rev-parse HEAD)'\"' -o bin/sensu-agent ./cmd/sensu-agent"
            - "artifact push job --expire-in 1d bin/sensu-agent"

        - name: "Repackage sensu-agent"
          depends_on:
            - "Build sensu-agent"
          commands:
            - "cd /" # go image defaults you in /go
            - "mkdir sensu-go-agent"
            - "curl -sfL -o ${SENSU_GO_PKG_NAME} https://packagecloud.io/sensu/stable/packages/debian/stretch/${SENSU_GO_PKG_NAME}/download.deb"
            - "dpkg-deb -x sensu-go-agent_6.4.1-4969_amd64.deb sensu-go-agent/"
            - "artifact pull job sensu-agent -fd sensu-go-agent/usr/sbin/sensu-agent"
            # Update sensu-agent binary in the md5sum file
            - "sed -e '#usr/sbin/sensu-agent# d' -i '' sensu-go-agent/md5sum"
            - "(cd sensu-go-agent; md5sum usr/sbin/sensu-agent) >> md5sum"
            - "dpkg-deb --build sensu-go-agent impero-${SENSU_GO_PKG_NAME}"
            - "artifact push job impero-${SENSU_GO_PKG_NAME}"
