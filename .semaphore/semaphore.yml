version: "v1.0"
name: "Sensu-go OSS Packager"

agent:
  machine:
    type: e1-standard-2

  containers:
    - name: "gobuilder"
      image: "registry.semaphoreci.com/golang:1.16.6-stretch"

blocks:
  - name: "sensu-agent"
    task:
      env_vars:
        - name: "SENSU_GO_VERSION"
          value: "v6.4.1"
        - name: "SENSU_GO_PKG_NAME"
          value: "sensu-go-agent_6.4.1-4969_amd64.deb"
      jobs:
        - name: "Build sensu-agent"
          commands:
            - "cd /" # go image defaults you in /go
            - "git -c advice.detachedHead=false clone --branch ${SENSU_GO_VERSION} --depth 1 https://github.com/sensu/sensu-go"
            - "cd sensu-go"
            - "go build -ldflags '-X \"github.com/sensu/sensu-go/version.Version='${SENSU_GO_VERSION}'\" -X \"github.com/sensu/sensu-go/version.BuildDate='$(date +%Y-%m-%d)'\" -X \"github.com/sensu/sensu-go/version.BuildSHA='$(git rev-parse HEAD)'\"' -o bin/sensu-agent ./cmd/sensu-agent"
            - "artifact push job --expire-in 1d bin/sensu-agent"
