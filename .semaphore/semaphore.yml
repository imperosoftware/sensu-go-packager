version: "v1.0"
name: "Sensu-go OSS Packager"

global_job_config:
  env_vars:
    - name: "SENSU_GO_VERSION"
      value: "v6.4.1"

agent:
  machine:
    type: e1-standard-2

  containers:
    - name: "gobuilder"
      image: "registry.semaphoreci.com/golang:1.16.6-stretch"

blocks:
  - name: "Build sensu-go binaries"
    dependencies: []
    task:
      jobs:
        - name: "Build sensu-go binaries"
          commands_file: "cmd/build-sensu-go-binaries.sh"

  - name: "Test sensu-go binaries"
    dependencies:
      - "Build sensu-go binaries"
    task:
      jobs:
        - name: "Test sensu-go agent"
          commands_file: "cmd/test-sensu-go-agent.sh"
        - name: "Test sensu-go backend"
          commands_file: "cmd/test-sensu-go-backend.sh"
        - name: "Test sensu-go ctl"
          commands_file: "cmd/test-sensu-go-ctl.sh"

  - name: "Repackage sensu-go deb packages"
    dependencies:
      - "Test sensu-go binaries"
    task:
      jobs:
        - name: "Repackage sensu-go-agent deb"
          commands_file: "cmd/repackage-sensu-go-agent-deb.sh"
