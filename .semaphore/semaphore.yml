version: "v1.0"
name: "Sensu-go OSS Packager"

global_job_config:
  env_vars:
    - name: "SENSU_GO_VERSION"
      value: "v6.4.1"
    - name: "SENSU_GO_PKG_NAME"
      value: "sensu-go-agent_6.4.1-4969_amd64.deb"

agent:
  machine:
    type: e1-standard-2

  containers:
    - name: "gobuilder"
      image: "registry.semaphoreci.com/golang:1.16.6-stretch"

blocks:
  - name: "Build sensu-go binaries"
    dependencies: []
    task:
      jobs:
        - name: "Build sensu-go agent"
          commands:
            - "cd /"
            - "git -c advice.detachedHead=false clone --branch ${SENSU_GO_VERSION} --depth 1 https://github.com/sensu/sensu-go"
            - "cd sensu-go"
            - "go build -ldflags '-X \"github.com/sensu/sensu-go/version.Version='${SENSU_GO_VERSION}'\" -X \"github.com/sensu/sensu-go/version.BuildDate='$(date +%Y-%m-%d)'\" -X \"github.com/sensu/sensu-go/version.BuildSHA='$(git rev-parse HEAD)'\"' -o bin/sensu-agent ./cmd/sensu-agent"
            - "go build -ldflags '-X \"github.com/sensu/sensu-go/version.Version='${SENSU_GO_VERSION}'\" -X \"github.com/sensu/sensu-go/version.BuildDate='$(date +%Y-%m-%d)'\" -X \"github.com/sensu/sensu-go/version.BuildSHA='$(git rev-parse HEAD)'\"' -o bin/sensu-backend ./cmd/sensu-backend"
            - "go build -ldflags '-X \"github.com/sensu/sensu-go/version.Version='${SENSU_GO_VERSION}'\" -X \"github.com/sensu/sensu-go/version.BuildDate='$(date +%Y-%m-%d)'\" -X \"github.com/sensu/sensu-go/version.BuildSHA='$(git rev-parse HEAD)'\"' -o bin/sensuctl ./cmd/sensuctl"
            - "artifact push workflow --expire-in 1d bin/sensu-agent"
            - "artifact push workflow --expire-in 1d bin/sensu-backend"
            - "artifact push workflow --expire-in 1d bin/sensuctl"

  - name: "Test sensu-go binaries"
    dependencies:
      - "Build sensu-go binaries"
    task:
      jobs:
        - name: "Test sensu-go agent"
          commands_file: "cmd/test-sensu-go-binaries/test-sensu-go-agent.sh"

  - name: "Repackage sensu-go deb packages"
    dependencies:
      - "Test sensu-go binaries"
    task:
      jobs:
        - name: "Repackage sensu-go-agent deb"
          commands:
            - "cd /"
            # Preparation to do a switcherooni
            - "mkdir sensu-go-agent"
            - "curl -sfL -o ${SENSU_GO_PKG_NAME} https://packagecloud.io/sensu/stable/packages/debian/stretch/${SENSU_GO_PKG_NAME}/download.deb"
            # Unpack the deb
            - "dpkg-deb -x ${SENSU_GO_PKG_NAME} sensu-go-agent/"
            - "pushd sensu-go-agent"
            # Swap out the binary
            - "rm usr/sbin/sensu-agent"
            - "artifact pull workflow sensu-agent --destination usr/sbin/sensu-agent"
            # Update md5sum with new binary's hash
            - "sed -e '/usr\\/sbin\\/sensu-agent/ d' -i '' md5sum"
            - "md5sum usr/sbin/sensu-agent >> md5sum"
            # Package everything back up
            - "dpkg-deb --build sensu-go-agent impero-${SENSU_GO_PKG_NAME}"
            - "artifact push workflow impero-${SENSU_GO_PKG_NAME}"
